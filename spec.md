# MVP チャットツール仕様書

## 1. 概要
本プロジェクトは、カードゲーム向けのRAG（検索拡張生成）ベースのチャットツールです。ユーザーがカードや戦略について質問すると、AIアシスタントがカードデータや関連ドキュメントに基づいて回答を提供します。

## 2. 現在の機能
- **バックエンド (FastAPI)**:
    - `/api/v1/chat`: チャットリクエストを処理するエンドポイント。
    - OpenAI (Embeddings & Chat) と Upstash Vector を使用したRAGパイプライン。
    - `data/data.json` からのカードマスターデータのインメモリ読み込み。
    - 特定のカード効果検索のためのエフェクト名前空間（Effect namespace）処理。
- **フロントエンド (Next.js)**:
    - メッセージ履歴付きのチャットインターフェース。
    - 関連カードの表示 (CardList コンポーネント)。
    - モーダルでの詳細カード表示 (CardItem/CardList)。
    - 基本的なエラーハンドリングとローディング状態の表示。
- **データ**:
    - カード詳細を含む `data/data.json`。

## 3. MVP要件
MVP（Minimum Viable Product）として完成し、初期リリース/テストの準備が整ったとみなすには、以下の要件を満たす必要があります。

### 機能要件
- [ ] **正確なRAG回答**: 一般的なクエリ（例：「コスト2のフォロワーを探して」「カードXは何をする？」）に対して、システムが関連するカードを適切に取得できること。
- [ ] **堅牢なエラーハンドリング**: API障害（OpenAI, Upstash）やネットワークの問題をシステムが適切に処理できること。
- [ ] **レスポンシブUI**: チャットインターフェースがデスクトップとモバイルの両方で快適に動作すること。
- [ ] **カード詳細**: 回答で言及されたカードの完全な詳細をユーザーが確認できること。

### 非機能要件
- [ ] **パフォーマンス**: チャットの回答が妥当な時間内（例：5秒未満）に生成されること。
- [ ] **セキュリティ**: APIキーが安全に管理されていること（環境変数）。
- [ ] **デプロイ**: アプリケーションがクラウドプロバイダー（例：フロントエンドはVercel、バックエンドはRender/Railwayなど）にデプロイ可能であること。

## 4. 残タスク

### バックエンド
- [ ] **エラーハンドリングの改善**: `_stage_error` を改良し、デバッグ用の詳細ログを維持しつつ、ユーザーにはより親切なエラーメッセージを提供する。
- [ ] **ユニットテスト**: `services.py`（特に `extract_effect_namespace` と `strip_effect_directive`）および `main.py` の基本的なユニットテストを追加する。
- [ ] **ヘルスチェックエンドポイント**: 監視用のシンプルな `/health` エンドポイントを追加する。
- [ ] **環境変数の検証**: 重要な環境変数（OPENAI_API_KEY, UPSTASH_VECTOR_URL）が欠落している場合にアプリが即座にエラー終了（Fail Fast）するようにする。

### フロントエンド
- [ ] **UIの洗練**:
    - 「読み込み中」インジケーターの改善（例：タイピングアニメーション）。
    - カードモーダルのモバイル表示の改善。
- [ ] **Markdownレンダリング**: チャット回答（Markdownが含まれる場合がある）が `ChatMessage.tsx` で正しくレンダリングされるようにする。
- [ ] **接続処理**: バックエンドに接続できない場合の再試行メカニズムまたは明確なエラーメッセージを追加する。

### データ & RAG
- [ ] **インデックス検証**: Upstash Vectorインデックスが `data.json` の最新データで入力されていることを確認する。（不足している場合にインデックスをシード/更新するスクリプトを作成する）。
- [ ] **プロンプトエンジニアリング**: `generate_answer` 内のシステムプロンプトを調整し、回答のトーンとフォーマットが「ゲーム攻略アシスタント」のペルソナと一致するようにする。

### ドキュメント & デプロイ
- [ ] **デプロイ設定**: 必要に応じて `vercel.json` などの設定ファイルを作成する。
- [ ] **環境セットアップガイド**: 必要な環境変数のリストとそれらの取得方法を明確にするために `README.md` を更新する。
